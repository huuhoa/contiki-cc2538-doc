<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>Contiki 3.x: example-psock-server.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Contiki 3.x
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">example-psock-server.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This is a small example of how to write a TCP server using</span></div>
<div class="line"><span class="comment"> * Contiki&#39;s protosockets. It is a simple server that accepts one line</span></div>
<div class="line"><span class="comment"> * of text from the TCP connection, and echoes back the first 10 bytes</span></div>
<div class="line"><span class="comment"> * of the string, and then closes the connection.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The server only handles one connection at a time.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * We include &quot;contiki-net.h&quot; to get all network definitions and</span></div>
<div class="line"><span class="comment"> * declarations.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#include &quot;contiki-net.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * We define one protosocket since we&#39;ve decided to only handle one</span></div>
<div class="line"><span class="comment"> * connection at a time. If we want to be able to handle more than one</span></div>
<div class="line"><span class="comment"> * connection at a time, each parallell connection needs its own</span></div>
<div class="line"><span class="comment"> * protosocket.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a name="_a0"></a><a class="code" href="a00073.html">psock</a> ps;</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * We must have somewhere to put incoming data, and we use a 10 byte</span></div>
<div class="line"><span class="comment"> * buffer for this purpose.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span> uint8_t buffer[10];</div>
<div class="line"></div>
<div class="line"><span class="comment">/*---------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * A protosocket always requires a protothread. The protothread</span></div>
<div class="line"><span class="comment"> * contains the code that uses the protosocket. We define the</span></div>
<div class="line"><span class="comment"> * protothread here.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">static</span></div>
<div class="line"><a name="a1"></a><a class="code" href="a00752.html#ga3d4c8bd4aada659eb34f5d2ffd3e7901">PT_THREAD</a>(handle_connection(<span class="keyword">struct</span> <a class="code" href="a00073.html">psock</a> *p))</div>
<div class="line">{</div>
<div class="line">  <span class="comment">/*</span></div>
<div class="line"><span class="comment">   * A protosocket&#39;s protothread must start with a PSOCK_BEGIN(), with</span></div>
<div class="line"><span class="comment">   * the protosocket as argument.</span></div>
<div class="line"><span class="comment">   *</span></div>
<div class="line"><span class="comment">   * Remember that the same rules as for protothreads apply: do NOT</span></div>
<div class="line"><span class="comment">   * use local variables unless you are very sure what you are doing!</span></div>
<div class="line"><span class="comment">   * Local (stack) variables are not preserved when the protothread</span></div>
<div class="line"><span class="comment">   * blocks.</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  <a name="a2"></a><a class="code" href="a00615.html#ga84901a5aa60040e96d272a69977edd22">PSOCK_BEGIN</a>(p);</div>
<div class="line"></div>
<div class="line">  <span class="comment">/*</span></div>
<div class="line"><span class="comment">   * We start by sending out a welcoming message. The message is sent</span></div>
<div class="line"><span class="comment">   * using the PSOCK_SEND_STR() function that sends a null-terminated</span></div>
<div class="line"><span class="comment">   * string.</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  <a name="a3"></a><a class="code" href="a00615.html#gab0ad55aa96dd1d200cd0fc5a99f6a4f7">PSOCK_SEND_STR</a>(p, <span class="stringliteral">&quot;Welcome, please type something and press return.\n&quot;</span>);</div>
<div class="line">  </div>
<div class="line">  <span class="comment">/*</span></div>
<div class="line"><span class="comment">   * Next, we use the PSOCK_READTO() function to read incoming data</span></div>
<div class="line"><span class="comment">   * from the TCP connection until we get a newline character. The</span></div>
<div class="line"><span class="comment">   * number of bytes that we actually keep is dependant of the length</span></div>
<div class="line"><span class="comment">   * of the input buffer that we use. Since we only have a 10 byte</span></div>
<div class="line"><span class="comment">   * buffer here (the buffer[] array), we can only remember the first</span></div>
<div class="line"><span class="comment">   * 10 bytes received. The rest of the line up to the newline simply</span></div>
<div class="line"><span class="comment">   * is discarded.</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  <a name="a4"></a><a class="code" href="a00615.html#gab5d9c0becf7cb32d0aaef466839dd92e">PSOCK_READTO</a>(p, <span class="charliteral">&#39;\n&#39;</span>);</div>
<div class="line">  </div>
<div class="line">  <span class="comment">/*</span></div>
<div class="line"><span class="comment">   * And we send back the contents of the buffer. The PSOCK_DATALEN()</span></div>
<div class="line"><span class="comment">   * function provides us with the length of the data that we&#39;ve</span></div>
<div class="line"><span class="comment">   * received. Note that this length will not be longer than the input</span></div>
<div class="line"><span class="comment">   * buffer we&#39;re using.</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  <a class="code" href="a00615.html#gab0ad55aa96dd1d200cd0fc5a99f6a4f7">PSOCK_SEND_STR</a>(p, <span class="stringliteral">&quot;Got the following data: &quot;</span>);</div>
<div class="line">  <a name="a5"></a><a class="code" href="a00615.html#ga70d236d1cf34b4e21836edda60247b70">PSOCK_SEND</a>(p, buffer, <a name="a6"></a><a class="code" href="a00615.html#ga4ab2de595d36e9e55dd61f6ecd139162">PSOCK_DATALEN</a>(p));</div>
<div class="line">  <a class="code" href="a00615.html#gab0ad55aa96dd1d200cd0fc5a99f6a4f7">PSOCK_SEND_STR</a>(p, <span class="stringliteral">&quot;Good bye!\r\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">  <span class="comment">/*</span></div>
<div class="line"><span class="comment">   * We close the protosocket.</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  <a name="a7"></a><a class="code" href="a00615.html#ga5d56800f82bfc7bbf53bb4a659589812">PSOCK_CLOSE</a>(p);</div>
<div class="line"></div>
<div class="line">  <span class="comment">/*</span></div>
<div class="line"><span class="comment">   * And end the protosocket&#39;s protothread.</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  <a name="a8"></a><a class="code" href="a00615.html#ga4a264bb64ae706d53f572b1d9e4037a2">PSOCK_END</a>(p);</div>
<div class="line">}</div>
<div class="line"><span class="comment">/*---------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * We declare the process and specify that it should be automatically started.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><a name="a9"></a><a class="code" href="a00684.html#ga27e9b6fc13f0438e37a198f69b38b4cf">PROCESS</a>(example_psock_server_process, <span class="stringliteral">&quot;Example protosocket server&quot;</span>);</div>
<div class="line">AUTOSTART_PROCESSES(&amp;example_psock_server_process);</div>
<div class="line"><span class="comment">/*---------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * The definition of the process.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><a name="a10"></a><a class="code" href="a00701.html#gad9ac47af91b8dc72c6a711aaec9690a0">PROCESS_THREAD</a>(example_psock_server_process, ev, data)</div>
<div class="line">{</div>
<div class="line">  <span class="comment">/*</span></div>
<div class="line"><span class="comment">   * The process begins here.</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  <a name="a11"></a><a class="code" href="a00684.html#ga8efc62947f2ca2c870f52896e0dc1a81">PROCESS_BEGIN</a>();</div>
<div class="line"></div>
<div class="line">  <span class="comment">/*</span></div>
<div class="line"><span class="comment">   * We start with setting up a listening TCP port. Note how we&#39;re</span></div>
<div class="line"><span class="comment">   * using the UIP_HTONS() macro to convert the port number (1010) to</span></div>
<div class="line"><span class="comment">   * network byte order as required by the tcp_listen() function.</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  <a name="a12"></a><a class="code" href="a00619.html#gafb6b81f8f3010563bf1a97205be39796">tcp_listen</a>(<a name="a13"></a><a class="code" href="a00625.html#ga703ee949a28cb00b5f8ee54bfe664e8d">UIP_HTONS</a>(1010));</div>
<div class="line"></div>
<div class="line">  <span class="comment">/*</span></div>
<div class="line"><span class="comment">   * We loop for ever, accepting new connections.</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  <span class="keywordflow">while</span>(1) {</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * We wait until we get the first TCP/IP event, which probably</span></div>
<div class="line"><span class="comment">     * comes because someone connected to us.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <a name="a14"></a><a class="code" href="a00684.html#ga996168a0f904c0e28e3f6ed18dddd129">PROCESS_WAIT_EVENT_UNTIL</a>(ev == <a name="a15"></a><a class="code" href="a00619.html#gaadf3c3b5770cafe3da7f8cc4dd06625c">tcpip_event</a>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * If a peer connected with us, we&#39;ll initialize the protosocket</span></div>
<div class="line"><span class="comment">     * with PSOCK_INIT().</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordflow">if</span>(<a name="a16"></a><a class="code" href="a00624.html#gadb971fb1525d0c5002f52125b05f3218">uip_connected</a>()) {</div>
<div class="line">      </div>
<div class="line">      <span class="comment">/*</span></div>
<div class="line"><span class="comment">       * The PSOCK_INIT() function initializes the protosocket and</span></div>
<div class="line"><span class="comment">       * binds the input buffer to the protosocket.</span></div>
<div class="line"><span class="comment">       */</span></div>
<div class="line">      <a name="a17"></a><a class="code" href="a00615.html#ga26ae707402e494f3895a9f012a93ea29">PSOCK_INIT</a>(&amp;ps, buffer, <span class="keyword">sizeof</span>(buffer));</div>
<div class="line"></div>
<div class="line">      <span class="comment">/*</span></div>
<div class="line"><span class="comment">       * We loop until the connection is aborted, closed, or times out.</span></div>
<div class="line"><span class="comment">       */</span></div>
<div class="line">      <span class="keywordflow">while</span>(!(<a name="a18"></a><a class="code" href="a00624.html#gafbd5fc486dfdf6bf6fc9db52b1f418c4">uip_aborted</a>() || <a name="a19"></a><a class="code" href="a00624.html#gaef6c4140c632b6a406779342cf3b6eb6">uip_closed</a>() || <a name="a20"></a><a class="code" href="a00624.html#ga7b2ac4b18bd2ac3912fe67b3b17158c3">uip_timedout</a>())) {</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * We wait until we get a TCP/IP event. Remember that we</span></div>
<div class="line"><span class="comment">         * always need to wait for events inside a process, to let</span></div>
<div class="line"><span class="comment">         * other processes run while we are waiting.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <a class="code" href="a00684.html#ga996168a0f904c0e28e3f6ed18dddd129">PROCESS_WAIT_EVENT_UNTIL</a>(ev == <a class="code" href="a00619.html#gaadf3c3b5770cafe3da7f8cc4dd06625c">tcpip_event</a>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * Here is where the real work is taking place: we call the</span></div>
<div class="line"><span class="comment">         * handle_connection() protothread that we defined above. This</span></div>
<div class="line"><span class="comment">         * protothread uses the protosocket to receive the data that</span></div>
<div class="line"><span class="comment">         * we want it to.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        handle_connection(&amp;ps);</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  </div>
<div class="line">  <span class="comment">/*</span></div>
<div class="line"><span class="comment">   * We must always declare the end of a process.</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  <a name="a21"></a><a class="code" href="a00684.html#ga9c2681a0070eba8a7c9fdf4dbb6db05e">PROCESS_END</a>();</div>
<div class="line">}</div>
<div class="line"><span class="comment">/*---------------------------------------------------------------------------*/</span></div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed May 27 2015 00:57:41 for Contiki 3.x by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.8
</small></address>
</body>
</html>
